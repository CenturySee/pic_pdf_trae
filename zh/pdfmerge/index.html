<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFæ–‡ä»¶åˆå¹¶å·¥å…·</title>
    <link rel="icon" href="../../favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="../../style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
</head>
<body>
    <!-- è¯­è¨€åˆ‡æ¢æŒ‰é’® -->
    <div class="language-switcher">
        <button class="lang-switch-btn active" onclick="changeLanguage('zh')">ä¸­æ–‡</button>
        <button class="lang-switch-btn" onclick="changeLanguage('en')">English</button>
        <button class="lang-switch-btn" onclick="changeLanguage('ja')">æ—¥æœ¬èª</button>
    </div>

    <div class="container">
        <aside class="sidebar">
            <h1>PDFå·¥å…·</h1>
            <nav>
                <a href="../pic2pdf/" class="nav-btn">å›¾ç‰‡è½¬PDF</a>
                <a href="../pdf2pic/" class="nav-btn">PDFè½¬å›¾ç‰‡</a>
                <button class="nav-btn active" data-tab="pdf-merge">PDFåˆå¹¶</button>
            </nav>
        </aside>
        <main class="main-content">
            <!-- PDFåˆå¹¶ -->
            <section id="pdf-merge" class="tab-content active">
                <div class="section-header">
                    <h2>PDFæ–‡ä»¶åˆå¹¶</h2>
                </div>
                
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-section">
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="fileInput" accept=".pdf" multiple style="display: none;">
                        <button id="uploadBtn" class="primary-btn">é€‰æ‹©PDFæ–‡ä»¶</button>
                        <p>æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„</p>
                        <div class="upload-info">
                            <small>æ”¯æŒå¤šä¸ªPDFæ–‡ä»¶ï¼ŒåŠ å¯†æ–‡ä»¶å°†åœ¨åˆå¹¶æ—¶è‡ªåŠ¨è·³è¿‡</small>
                        </div>
                    </div>
                </div>

                <!-- æ§åˆ¶åŒºåŸŸ -->
                <div class="controls-section">
                    <div class="controls-group">
                        <div class="control-item">
                            <label>è¾“å‡ºæ–‡ä»¶å:</label>
                            <input type="text" id="outputFilename" value="merged.pdf" placeholder="è¾“å…¥åˆå¹¶åçš„æ–‡ä»¶å">
                        </div>
                        <div class="control-item">
                            <button class="secondary-btn" onclick="sortByName()">æŒ‰åç§°æ’åº</button>
                            <button class="secondary-btn" onclick="sortByTime()">æŒ‰æ—¶é—´æ’åº</button>
                        </div>
                        <button id="mergeBtn" class="primary-btn" disabled>åˆå¹¶PDFæ–‡ä»¶</button>
                    </div>
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress-fill" id="progressFill"></div>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>

                <!-- çŠ¶æ€ä¿¡æ¯ -->
                <div id="status" class="status-message" style="display: none;"></div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="preview-section">
                    <div class="preview-header">
                        <h3>PDFæ–‡ä»¶åˆ—è¡¨</h3>
                        <span id="fileCount" class="file-count">0 ä¸ªæ–‡ä»¶</span>
                    </div>
                    <div id="fileList" class="file-list">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“„</div>
                            <p>æš‚æ— PDFæ–‡ä»¶ï¼Œè¯·ä¸Šä¼ æ–‡ä»¶</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let uploadedFiles = [];
        let fileIdCounter = 0;

        // DOMå…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const mergeBtn = document.getElementById('mergeBtn');
        const fileList = document.getElementById('fileList');
        const fileCount = document.getElementById('fileCount');
        const outputFilename = document.getElementById('outputFilename');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const status = document.getElementById('status');

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
        });

        function setupEventListeners() {
            // ä¸Šä¼ æŒ‰é’®ç‚¹å‡»
            uploadBtn.addEventListener('click', () => fileInput.click());
            
            // æ–‡ä»¶é€‰æ‹©
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            
            // åˆå¹¶æŒ‰é’®
            mergeBtn.addEventListener('click', mergePDFs);
        }

        // è¯­è¨€åˆ‡æ¢
        function changeLanguage(lang) {
            // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.lang-switch-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // è·å–å½“å‰è·¯å¾„
            const path = window.location.pathname;
            
            // æ„å»ºæ–°çš„è¯­è¨€è·¯å¾„
            let newPath;
            if (path.includes('/en/')) {
                newPath = path.replace('/en/', `/${lang}/`);
            } else if (path.includes('/zh/')) {
                newPath = path.replace('/zh/', `/${lang}/`);
            } else if (path.includes('/ja/')) {
                newPath = path.replace('/ja/', `/${lang}/`);
            } else {
                // å¦‚æœå½“å‰ä¸åœ¨è¯­è¨€ç›®å½•ä¸­ï¼Œç›´æ¥æ·»åŠ è¯­è¨€ç›®å½•
                newPath = `/${lang}/`;
            }
            
            // é‡å®šå‘åˆ°æ–°è·¯å¾„
            window.location.href = newPath;
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        async function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            await processFiles(files);
        }

        // æ‹–æ‹½å¤„ç†
        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        async function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files);
            await processFiles(files);
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function processFiles(files) {
            const pdfFiles = files.filter(file => file.type === 'application/pdf');
            
            if (pdfFiles.length === 0) {
                showStatus('è¯·é€‰æ‹©PDFæ–‡ä»¶', 'error');
                return;
            }

            showStatus('æ­£åœ¨æ£€æµ‹PDFæ–‡ä»¶...', 'info');
            
            // æ£€æµ‹æ¯ä¸ªPDFæ–‡ä»¶çš„åŠ å¯†çŠ¶æ€
            for (const file of pdfFiles) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    let isEncrypted = false;
                    
                    try {
                        // å°è¯•æ­£å¸¸åŠ è½½PDF
                        await PDFLib.PDFDocument.load(arrayBuffer);
                    } catch (error) {
                        // å¦‚æœåŠ è½½å¤±è´¥ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯åŠ å¯†é”™è¯¯
                        if (error.message.includes('encrypted')) {
                            isEncrypted = true;
                        } else {
                            isEncrypted = true;
                        }
                    }

                    const fileObj = {
                        id: fileIdCounter++,
                        file: file,
                        name: file.name,
                        size: file.size,
                        uploadTime: new Date(),
                        isEncrypted: isEncrypted
                    };
                    uploadedFiles.push(fileObj);
                    
                } catch (error) {
                    console.error('æ£€æµ‹PDFæ–‡ä»¶æ—¶å‡ºé”™:', error);
                    const fileObj = {
                        id: fileIdCounter++,
                        file: file,
                        name: file.name,
                        size: file.size,
                        uploadTime: new Date(),
                        isEncrypted: true
                    };
                    uploadedFiles.push(fileObj);
                }
            }

            updateFileList();
            
            const encryptedCount = uploadedFiles.filter(f => f.isEncrypted).length;
            if (encryptedCount > 0) {
                showStatus(`æˆåŠŸæ·»åŠ  ${pdfFiles.length} ä¸ªPDFæ–‡ä»¶ï¼Œå…¶ä¸­ ${encryptedCount} ä¸ªä¸ºåŠ å¯†æ–‡ä»¶`, 'info');
            } else {
                showStatus(`æˆåŠŸæ·»åŠ  ${pdfFiles.length} ä¸ªPDFæ–‡ä»¶`, 'success');
            }
        }

        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
        function updateFileList() {
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“„</div>
                        <p>æš‚æ— PDFæ–‡ä»¶ï¼Œè¯·ä¸Šä¼ æ–‡ä»¶</p>
                    </div>
                `;
                fileCount.textContent = '0 ä¸ªæ–‡ä»¶';
                mergeBtn.disabled = true;
                return;
            }

            fileCount.textContent = `${uploadedFiles.length} ä¸ªæ–‡ä»¶`;
            mergeBtn.disabled = uploadedFiles.length < 2;

            fileList.innerHTML = uploadedFiles.map((fileObj, index) => `
                <div class="file-item" draggable="true" data-id="${fileObj.id}">
                    <div class="file-info">
                        <div class="file-name">${index + 1}. ${fileObj.name}</div>
                        <div class="file-meta">
                            <span class="file-size">${formatFileSize(fileObj.size)}</span>
                            <span class="file-time">${formatDate(fileObj.uploadTime)}</span>
                            <span class="status-badge ${fileObj.isEncrypted ? 'encrypted' : 'normal'}">
                                ${fileObj.isEncrypted ? 'ğŸ”’ åŠ å¯†' : 'âœ… æ­£å¸¸'}
                            </span>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="remove-btn" onclick="removeFile(${fileObj.id})" title="åˆ é™¤æ–‡ä»¶">âœ•</button>
                    </div>
                </div>
            `).join('');

            // è®¾ç½®æ‹–æ‹½æ’åº
            setupDragAndDrop();
        }

        // è®¾ç½®æ‹–æ‹½æ’åº
        function setupDragAndDrop() {
            const fileItems = document.querySelectorAll('.file-item');
            let draggedElement = null;

            fileItems.forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });

                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (draggedElement !== this) {
                        const draggedId = parseInt(draggedElement.dataset.id);
                        const targetId = parseInt(this.dataset.id);
                        
                        const draggedIndex = uploadedFiles.findIndex(f => f.id === draggedId);
                        const targetIndex = uploadedFiles.findIndex(f => f.id === targetId);
                        
                        // é‡æ–°æ’åºæ•°ç»„
                        const [draggedFile] = uploadedFiles.splice(draggedIndex, 1);
                        uploadedFiles.splice(targetIndex, 0, draggedFile);
                        
                        updateFileList();
                    }
                });
            });
        }

        // åˆ é™¤æ–‡ä»¶
        function removeFile(fileId) {
            uploadedFiles = uploadedFiles.filter(file => file.id !== fileId);
            updateFileList();
            showStatus('æ–‡ä»¶å·²åˆ é™¤', 'info');
        }

        // æ’åºåŠŸèƒ½
        function sortByName() {
            uploadedFiles.sort((a, b) => a.name.localeCompare(b.name));
            updateFileList();
            showStatus('å·²æŒ‰æ–‡ä»¶åæ’åº', 'info');
        }

        function sortByTime() {
            uploadedFiles.sort((a, b) => a.uploadTime - b.uploadTime);
            updateFileList();
            showStatus('å·²æŒ‰ä¸Šä¼ æ—¶é—´æ’åº', 'info');
        }

        // åˆå¹¶PDFæ–‡ä»¶
        async function mergePDFs() {
            if (uploadedFiles.length < 2) {
                showStatus('è‡³å°‘éœ€è¦2ä¸ªPDFæ–‡ä»¶æ‰èƒ½åˆå¹¶', 'error');
                return;
            }

            // è¿‡æ»¤æ‰åŠ å¯†çš„PDFæ–‡ä»¶
            const normalFiles = uploadedFiles.filter(f => !f.isEncrypted);
            const encryptedFiles = uploadedFiles.filter(f => f.isEncrypted);
            
            if (encryptedFiles.length > 0) {
                showStatus(`æ£€æµ‹åˆ° ${encryptedFiles.length} ä¸ªåŠ å¯†PDFæ–‡ä»¶ï¼Œå°†è‡ªåŠ¨è·³è¿‡è¿™äº›æ–‡ä»¶`, 'info');
                console.log('è·³è¿‡çš„åŠ å¯†æ–‡ä»¶:', encryptedFiles.map(f => f.name));
            }

            if (normalFiles.length < 2) {
                showStatus(`è¿‡æ»¤ååªæœ‰ ${normalFiles.length} ä¸ªæ­£å¸¸PDFæ–‡ä»¶ï¼Œè‡³å°‘éœ€è¦2ä¸ªæ–‡ä»¶æ‰èƒ½åˆå¹¶`, 'error');
                return;
            }

            const outputFileName = outputFilename.value.trim() || 'merged.pdf';
            
            mergeBtn.disabled = true;
            progressContainer.style.display = 'block';
            showStatus('æ­£åœ¨åˆå¹¶PDFæ–‡ä»¶...', 'info');

            try {
                const mergedPdf = await PDFLib.PDFDocument.create();
                const totalFiles = normalFiles.length;
                let processedFiles = 0;
                let failedFiles = [];

                for (let i = 0; i < normalFiles.length; i++) {
                    const fileObj = normalFiles[i];
                    
                    try {
                        const arrayBuffer = await fileObj.file.arrayBuffer();
                        const pdf = await PDFLib.PDFDocument.load(arrayBuffer);
                        
                        const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
                        pages.forEach(page => mergedPdf.addPage(page));
                        processedFiles++;
                        
                    } catch (error) {
                        console.error(`å¤„ç†æ–‡ä»¶ ${fileObj.name} æ—¶å‡ºé”™:`, error);
                        failedFiles.push(fileObj.name);
                    }
                    
                    // æ›´æ–°è¿›åº¦æ¡
                    const progress = ((i + 1) / totalFiles) * 100;
                    progressFill.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                }

                if (processedFiles === 0) {
                    throw new Error('æ²¡æœ‰æˆåŠŸå¤„ç†ä»»ä½•PDFæ–‡ä»¶');
                }

                const mergedPdfBytes = await mergedPdf.save();
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = outputFileName.endsWith('.pdf') ? outputFileName : outputFileName + '.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                let successMessage = `PDFæ–‡ä»¶åˆå¹¶æˆåŠŸï¼å·²ä¸‹è½½ä¸º ${a.download}`;
                if (encryptedFiles.length > 0) {
                    successMessage += `\nè·³è¿‡çš„åŠ å¯†æ–‡ä»¶: ${encryptedFiles.map(f => f.name).join(', ')}`;
                }
                if (failedFiles.length > 0) {
                    successMessage += `\nå¤„ç†å¤±è´¥çš„æ–‡ä»¶: ${failedFiles.join(', ')}`;
                }
                showStatus(successMessage, 'success');
                
            } catch (error) {
                console.error('åˆå¹¶PDFæ—¶å‡ºé”™:', error);
                showStatus(`åˆå¹¶PDFæ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');
            } finally {
                mergeBtn.disabled = false;
                setTimeout(() => {
                    progressContainer.style.display = 'none';
                    progressFill.style.width = '0%';
                    progressText.textContent = '0%';
                }, 2000);
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status-message ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>

    <style>
        /* PDFåˆå¹¶é¡µé¢ç‰¹å®šæ ·å¼ */
        .file-list {
            min-height: 200px;
        }

        .file-item {
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            transition: var(--transition);
        }

        .file-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .file-item.dragging {
            opacity: 0.8;
            transform: rotate(3deg) scale(1.05);
            box-shadow: var(--shadow-lg);
            z-index: 10;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .file-meta {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-size {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .file-time {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .remove-btn:hover {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge.encrypted {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .status-badge.normal {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .file-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-message {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }

        .status-message.success {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-message.error {
            background-color: #fee2e2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .status-message.info {
            background-color: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .upload-info {
            margin-top: 0.5rem;
        }

        .upload-info small {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* å“åº”å¼è®¾è®¡è°ƒæ•´ */
        @media (max-width: 768px) {
            .file-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .controls-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-item {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
    <script src="script.js"></script>
</body>
</html>